<!DOCTYPE html>
<html>
<head>
	<title>Spark Map 2021</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
  integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
  crossorigin=""/>
	<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
	<style>
		  body { margin:0; padding:0; }
		  #map { position:absolute; top:0; bottom:0; width:100%; }
	</style>
	
</head>
<body>
	<div id="map"></div>
		<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
		<script src="https://unpkg.com/@turf/turf@3.5.2/turf.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script src="data/stl-buildings.geojson" type="text/javascript"></script>
		<script src="data/teamO-ways.geojson" type="text/javascript"></script>
		<script src="data/teamE-ways.geojson" type="text/javascript"></script>
		<script src="data/teamE-buildings.geojson" type="text/javascript"></script>
		<script src="osmtogeojson.js" type="text/javascript"></script>
		<script src="spark.js" type="text/javascript"></script>
	<script type="text/javascript">

		/* Map Variables */


		// Set URLs for the GeoJSONs we will be using
		var buildingsURL = "data/stl-buildings.geojson";
		var OwaysURL = "data/teamO-ways.geojson";
		var EwaysURL = "data/teamE-ways.geojson";
		var EbuildingsURL = "data/teamE-buildings.geojson";
		
		// Create the map variable
		var map = L.map('map')
			.setView([38.6836, -90.1923], 12)
			.on('click', onMapClick);

		// Add OSM Tile Layer
		var osmTiles = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
          	attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
      		}).addTo(map);

		var esriImagery = L.tileLayer('https://wayback.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/WMTS/1.0.0/default028mm/MapServer/tile/16749/{z}/{y}/{x}').addTo(map);

		// Add buildings layer
		var buildingsLayer = L.geoJSON(null, {
			// Change the style based on property
			style: function(feature) {
				if (feature.properties.building == 'house') {
					return buildingsStyle
				} else if (feature.properties.builing == 'school') {
					return buildingsStyle
				} else {
					return otherStyle
				}
			},
			onEachFeature: function(feature, layer) {
				addPopUp(feature,layer);
			}
		});

		$.getJSON(buildingsURL, function(data){
			buildingsLayer.addData(data).addTo(map);
		})

		// Add ways layer
		var OwaysLayer = L.geoJSON(null, {
			style: OwaysStyle,
			onEachFeature: function(feature, layer) {
				addPopUp(feature,layer);
			}
		});

		$.getJSON(OwaysURL, function(data){
			OwaysLayer.addData(data).addTo(map);
			
		});

		// Add ways layer
		var EwaysLayer = L.geoJSON(null, {
			style: EwaysStyle,
			onEachFeature: function(feature, layer) {
				addPopUp(feature,layer);
			}
		});

		$.getJSON(EwaysURL, function(data){
			EwaysLayer.addData(data).addTo(map);
		});
		
		
		// Add ways layer
		var EbuildingsLayer = L.geoJSON(null, {
		
		 style: function(feature) {
			if (feature.properties.building == 'school') {
		 		return schoolStyle
		 	} else if (feature.properties.builing == 'house') {
		 		return houseStyle
			} else if (feature.properties.builing == 'apartments') {
		 		return apartmentsStyle
			} else if (feature.properties.builing == 'garage') {
		 		return garageStyle
			} else if (feature.properties.builing == 'garages') {
		 		return garagesStyle
			} else if (feature.properties.builing == 'yes') {
		 		return yesStyle
		 	} else {
				return otherStyle
			}
		 },
			onEachFeature: function(feature, layer) {
				addPopUp(feature,layer);
			}
		});

		$.getJSON(EbuildingsURL, function(data){
			EbuildingsLayer.addData(data).addTo(map);
		})
		

		// Add the layers to their layer group
		var baseMaps = {
			"OpenStreetMap": osmTiles,
			"ESRI Imagery": esriImagery
		};

		var overlayMaps = {
			"Team O Buildings": buildingsLayer,
			"Team O Ways": OwaysLayer,
			"Team E Ways": EwaysLayer,
			"Team E Builings": EbuildingsLayer
		};

		var gjLayers = new L.LayerGroup();
		gjLayers.addTo(map);

		// Add a control to turn layers on and off
		var layerControl = L.control.layers(baseMaps, overlayMaps);
		map.addControl(layerControl);
		//L.control.layers(baseMaps, overlayMaps).addTo(map);

		// Let's add a button to go to OpenStreetMap using the visual extent
		// Let's add a button to go to OpenStreetMap using the visual extent
		L.Control.Button = L.Control.extend({
		    options: {
		        position: 'topleft'
		    },
		    onAdd: function (map) {
		        var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
		        var button1 = L.DomUtil.create('a', 'leaflet-control-button', container);
		        L.DomEvent.disableClickPropagation(button1);
		        L.DomEvent.on(button1, 'click', function(){
		            var osmURL = `https://www.openstreetmap.org/#map=${map.getZoom()}/${map.getCenter().lat}/${map.getCenter().lng}`;
		            window.open(osmURL, '_blank');
		        });

		        button1.innerHTML = '<img style="max-width:100%; max-height:100%" src="img/osm.png">';

		        var button2 = L.DomUtil.create('a', 'leaflet-control-button', container);
		        L.DomEvent.disableClickPropagation(button2);
		        L.DomEvent.on(button2, 'click', function(){
		        	if(map.getZoom() < 14) {
		        		alert("Please zoom in!")
		        	} else {
			        	var query = window.prompt("What do you want to query?",'["building"="yes"]');
			        	if (query == null || query == "") {
			        		//user cancelled
			        	} else {
								var bounds = map.getBounds();
								var overpassURL = `https://overpass-api.de/api/interpreter?data=[timeout:25];(way${query}(${bounds._southWest.lat},${bounds._southWest.lng},${bounds._northEast.lat},${bounds._northEast.lng});); out body;>;out skel qt;`
				        		var outdata = getXML(overpassURL, layerControl);
				        	}
		        	}
		        });

		        button2.innerHTML = '<img style="max-width:100%; max-height:100%" src="img/overpass.png">';		  

		        container.title = "View on OpenStreetMap";

		        return container;
		    },
		    onRemove: function(map) {},
		});
		var control = new L.Control.Button()
		control.addTo(map);

		function onMapClick(e) {			
			console.log(e.latlng.toString());
		}

	</script>

</body>
</html>
